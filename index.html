<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartoon Marble Run - No Jam Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap');

        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --dark: #2C3E50;
            --light: #F7F9FC;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #87CEEB;
            font-family: 'Nunito', sans-serif;
            user-select: none;
        }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω */
        #bg-clouds {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.4) 10%, transparent 20%),
                radial-gradient(circle at 80% 30%, rgba(255,255,255,0.4) 15%, transparent 30%);
            background-size: 120% 120%;
            animation: cloudsMove 60s infinite linear;
            z-index: -1;
        }
        @keyframes cloudsMove { 0% { background-position: 0% 0%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 0%; } }

        #game-container { position: relative; width: 100vw; height: 100vh; }
        canvas { display: block; filter: saturate(1.2) contrast(1.1); }

        /* UI */
        .ui-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(44, 62, 80, 0.95); z-index: 10;
            transition: opacity 0.5s; backdrop-filter: blur(5px);
        }
        .hidden { opacity: 0; pointer-events: none; }
        
        h1 { font-family: 'Fredoka One', cursive; font-size: 3.5rem; color: var(--accent); margin-bottom: 20px; text-shadow: 3px 3px var(--primary); text-align: center;}
        .panel { background: var(--light); padding: 30px; border-radius: 20px; text-align: center; border: 5px solid var(--secondary); max-width: 500px;}
        
        input[type="number"] { padding: 10px; font-size: 1.5rem; border-radius: 10px; border: 3px solid var(--secondary); width: 80px; text-align: center; font-family: 'Fredoka One'; color: var(--primary); }
        
        .file-upload-btn { background: var(--secondary); color: white; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; display: inline-block; margin: 10px 0; }
        #photo-upload { display: none; }
        
        .btn { background: var(--primary); color: white; padding: 15px 40px; font-size: 1.8rem; border: none; border-radius: 40px; cursor: pointer; font-family: 'Fredoka One'; margin-top: 20px; box-shadow: 0 6px 0 #c0392b; transition: 0.1s; }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #c0392b; }

        .preview-container { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
        .preview-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }

        #hud { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.9); padding: 10px 20px; border-radius: 15px; border: 3px solid var(--accent); font-weight: bold; font-family: 'Fredoka One'; font-size: 1.2rem; color: var(--dark); z-index: 5; }

        #winner-avatar { width: 150px; height: 150px; border-radius: 50%; border: 8px solid var(--accent); margin: 20px; object-fit: cover; background: #fff; }
    </style>
</head>
<body>
    <div id="bg-clouds"></div>
    <div id="game-container">
        <div id="hud" class="hidden">–õ–∏–¥–µ—Ä: <span id="leader-name">---</span></div>
    </div>

    <div id="start-screen" class="ui-screen">
        <h1>–ì–æ–Ω–∫–∞ –®–∞—Ä–∏–∫–æ–≤ 2.0</h1>
        <div class="panel">
            <label style="font-size: 1.2rem; font-weight:bold; display:block; margin-bottom:10px;">–°–∫–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤?</label>
            <input type="number" id="ball-count" value="30" min="2" max="100">
            <br>
            <label for="photo-upload" class="file-upload-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ üì∏</label>
            <input type="file" id="photo-upload" accept="image/*" multiple>
            <div class="preview-container" id="preview-area"></div>
        </div>
        <button class="btn" onclick="startGame()">–ü–û–ì–ù–ê–õ–ò!</button>
    </div>

    <div id="winner-screen" class="ui-screen hidden">
        <h1 style="color: gold;">üèÜ –ü–û–ë–ï–î–ò–¢–ï–õ–¨ üèÜ</h1>
        <img id="winner-avatar" src="" alt="Winner">
        <h2 id="winner-text" style="color: white; font-family: 'Fredoka One'; font-size: 2rem;"></h2>
        <button class="btn" onclick="location.reload()">–ù–û–í–ê–Ø –ò–ì–†–ê</button>
    </div>

    <script>
        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'start') {
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.4);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(); osc.stop(now + 0.4);
            } else if (type === 'win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.setValueAtTime(600, now + 0.1);
                osc.frequency.setValueAtTime(800, now + 0.2);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 1.0);
                osc.start(); osc.stop(now + 1.0);
            }
        }

        // --- PHYSICS SETUP ---
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner,
              Bodies = Matter.Bodies, Composite = Matter.Composite, Body = Matter.Body;

        let engine, runner, canvas, ctx;
        let balls = [];
        let userImages = [];
        let isRaceActive = false;
        let cameraY = 0;
        let width = window.innerWidth;
        let height = window.innerHeight;

        // CONFIG
        const ballRadius = 16;
        const gravityY = 0.5; // –ß—É—Ç—å –±–æ–ª—å—à–µ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏, —á—Ç–æ–±—ã –¥–∞–≤–∏–ª–∏ –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞
        
        // --- UPLOAD ---
        document.getElementById('photo-upload').addEventListener('change', function(e) {
            const files = e.target.files;
            const area = document.getElementById('preview-area');
            area.innerHTML = ''; userImages = [];
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image(); img.src = ev.target.result;
                    userImages.push(img);
                    const t = document.createElement('img'); t.src = ev.target.result; t.className='preview-img'; area.appendChild(t);
                };
                reader.readAsDataURL(file);
            });
        });

        function init() {
            engine = Engine.create();
            engine.world.gravity.y = gravityY;
            canvas = document.createElement('canvas');
            canvas.width = width; canvas.height = height;
            document.getElementById('game-container').appendChild(canvas);
            ctx = canvas.getContext('2d');
            runner = Runner.create();
        }

        // --- TRACK GENERATOR (ANTI-JAM VERSION) ---
        function createTrack() {
            const world = engine.world;
            let currentY = 150;
            let side = 1;

            const createWall = (x, y, w, h, angle, color) => {
                return Bodies.rectangle(x, y, w, h, {
                    isStatic: true, angle: angle,
                    friction: 0, // SLIPPERY WALLS
                    render: { fillStyle: color, strokeStyle: '#2C3E50', lineWidth: 4 },
                    chamfer: { radius: 5 }
                });
            };

            // Start Funnel - WIDE
            Composite.add(world, [
                createWall(width*0.2, currentY, width*0.5, 20, Math.PI/5, '#4ECDC4'),
                createWall(width*0.8, currentY, width*0.5, 20, -Math.PI/5, '#4ECDC4')
            ]);
            currentY += 350;

            for (let i = 0; i < 10; i++) {
                const type = i % 3;
                const color = ['#FF6B6B', '#FFE66D', '#4ECDC4'][i%3];
                
                if (type === 0) { // Slopes
                    const w = width * 0.8;
                    const x = width/2 + (width*0.1 * -side);
                    Composite.add(world, createWall(x, currentY, w, 20, 0.2 * side, color));
                    currentY += 300;
                } 
                else if (type === 1) { // The Funnel (Problem Area Fixed)
                    // Make gap explicitly wide (3.5 balls wide)
                    const gap = ballRadius * 3.5; 
                    const funnelH = 250;
                    
                    // Left wall
                    Composite.add(world, createWall(width/2 - 250, currentY, 400, 20, Math.PI/5, color));
                    // Right wall
                    Composite.add(world, createWall(width/2 + 250, currentY, 400, 20, -Math.PI/5, color));
                    
                    // Vertical chutes to guide them straight down (prevents wedging)
                    Composite.add(world, createWall(width/2 - gap - 10, currentY + 160, 20, 100, 0, color));
                    Composite.add(world, createWall(width/2 + gap + 10, currentY + 160, 20, 100, 0, color));

                    // Add a Spinner in the middle to mix them up
                    const spinner = Bodies.rectangle(width/2, currentY + 50, 150, 20, { 
                        render: { fillStyle: '#FFF' }, friction: 0 
                    });
                    const constraint = Matter.Constraint.create({
                        pointA: { x: width/2, y: currentY + 50 }, bodyB: spinner, length: 0, stiffness: 0.9
                    });
                    Composite.add(world, [spinner, constraint]);

                    currentY += 450;
                }
                else { // Pins/Bumpers (Plinko)
                   const rows = 4;
                   Composite.add(world, createWall(width/2, currentY + 150, width, 20, 0.1 * side, color)); // Floor
                   for(let r=0; r<rows; r++) {
                       for(let c=0; c<6; c++) {
                           const bx = (width/2 - 200) + c * 80 + (r%2==0?40:0);
                           const by = currentY + r * 60 - 50;
                           Composite.add(world, Bodies.circle(bx, by, 10, { isStatic: true, render: { fillStyle: '#fff' }, friction:0 }));
                       }
                   }
                   currentY += 400;
                }
                side *= -1;
            }

            // Finish
            trackLength = currentY + 200;
            Composite.add(world, Bodies.rectangle(width/2, trackLength, width, 100, { isStatic: true, label: 'finish' }));
        }
        let trackLength = 0;

        // --- ANT-JAM SYSTEM ---
        // Every 500ms, check for lazy balls
        setInterval(() => {
            if(!isRaceActive) return;
            balls.forEach(b => {
                // If ball is slow AND not at finish line
                if (b.speed < 0.3 && b.position.y < trackLength - 200) {
                    // Apply a tiny random nudge
                    Body.setVelocity(b, {
                        x: (Math.random() - 0.5) * 3,
                        y: -2 // Pop up slightly
                    });
                }
            });
        }, 500);

        function startGame() {
            const count = parseInt(document.getElementById('ball-count').value);
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            init();
            createTrack();
            playSound('start');

            for (let i = 0; i < count; i++) {
                setTimeout(() => { // Spawn with slight delay to reduce initial stack
                    const x = width/2 + (Math.random()*40 - 20);
                    const y = -50;
                    const img = userImages.length ? userImages[i % userImages.length] : null;
                    const color = `hsl(${Math.random()*360}, 80%, 70%)`;
                    
                    const ball = Bodies.circle(x, y, ballRadius, {
                        restitution: 0.6, // Bouncier
                        friction: 0.001, // Ice-like friction
                        frictionStatic: 0, // NO STICKING
                        frictionAir: 0.01,
                        density: 0.05,
                        label: 'marble',
                        render: { fillStyle: color }
                    });
                    ball.customId = i+1; ball.customImg = img; ball.customColor = color;
                    balls.push(ball);
                    Composite.add(engine.world, ball);
                }, i * 50);
            }
            isRaceActive = true;
            Runner.run(runner, engine);
            requestAnimationFrame(gameLoop);
        }

        // --- RENDER ---
        function draw() {
            // Camera
            let leadY = -Infinity; let leaderName = "";
            balls.forEach(b => { if(b.position.y > leadY) { leadY = b.position.y; leaderName="#"+b.customId; }});
            if(leaderName) document.getElementById('leader-name').innerText = leaderName;

            let targetY = -leadY + height * 0.6;
            if(targetY > 100) targetY = 100;
            if(targetY < -(trackLength - height + 100)) targetY = -(trackLength - height + 100);
            cameraY += (targetY - cameraY) * 0.1;

            ctx.clearRect(0,0,width,height);
            ctx.save();
            ctx.translate(0, cameraY);

            Composite.allBodies(engine.world).forEach(b => {
                if(b.position.y+cameraY < -200 || b.position.y+cameraY > height+200) return;
                
                ctx.beginPath();
                b.vertices.forEach((v,i) => i==0?ctx.moveTo(v.x,v.y):ctx.lineTo(v.x,v.y));
                ctx.closePath();

                if(b.label === 'marble') {
                    ctx.save();
                    ctx.translate(b.position.x, b.position.y);
                    ctx.rotate(b.angle);
                    ctx.beginPath(); ctx.arc(0,0,ballRadius,0,Math.PI*2); ctx.clip();
                    if(b.customImg) ctx.drawImage(b.customImg, -ballRadius, -ballRadius, ballRadius*2, ballRadius*2);
                    else {
                        ctx.fillStyle = b.customColor; ctx.fill();
                        ctx.fillStyle = "white"; ctx.font="12px Arial"; ctx.textAlign="center"; ctx.fillText(b.customId, 0, 4);
                    }
                    // Shine
                    ctx.beginPath(); ctx.arc(-5,-5, 5, 0, Math.PI*2); ctx.fillStyle="rgba(255,255,255,0.4)"; ctx.fill();
                    ctx.restore();
                    
                    if(b.position.y > trackLength - 100) endGame(b);
                } else {
                    ctx.fillStyle = b.render.fillStyle; ctx.fill();
                    ctx.strokeStyle = b.render.strokeStyle; ctx.lineWidth=3; ctx.stroke();
                }
            });
            ctx.restore();
        }

        function endGame(winner) {
            if(!isRaceActive) return;
            isRaceActive = false;
            playSound('win');
            document.getElementById('winner-screen').classList.remove('hidden');
            document.getElementById('hud').classList.add('hidden');
            const img = document.getElementById('winner-avatar');
            if(winner.customImg) img.src = winner.customImg.src;
            else { img.src = ""; img.style.background = winner.customColor; }
            document.getElementById('winner-text').innerText = "–ú—Ä–∞–º–æ—Ä #" + winner.customId;
            Runner.stop(runner);
        }

        function gameLoop() {
            if(!isRaceActive) return;
            draw();
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
