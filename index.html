<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartoon Marble Run</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap');

        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --dark: #2C3E50;
            --light: #F7F9FC;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #87CEEB; /* Sky blue */
            font-family: 'Nunito', sans-serif;
            user-select: none;
        }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω —Å –æ–±–ª–∞–∫–∞–º–∏ */
        #bg-clouds {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.4) 10%, transparent 20%),
                radial-gradient(circle at 80% 30%, rgba(255,255,255,0.4) 15%, transparent 30%),
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.3) 25%, transparent 50%);
            background-size: 120% 120%;
            animation: cloudsMove 60s infinite linear;
            z-index: -1;
        }

        @keyframes cloudsMove {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 0%; }
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        canvas {
            display: block;
            /* –§–∏–ª—å—Ç—Ä –¥–ª—è –º—É–ª—å—Ç—è—à–Ω–æ—Å—Ç–∏ */
            filter: saturate(1.2) contrast(1.1);
        }

        /* UI Overlay Styles */
        .ui-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(44, 62, 80, 0.9); /* Dark semi-transparent */
            z-index: 10;
            transition: opacity 0.5s, transform 0.5s;
            backdrop-filter: blur(5px);
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(1.1);
        }

        h1 {
            font-family: 'Fredoka One', cursive;
            font-size: 4rem;
            color: var(--accent);
            text-shadow: 3px 3px 0 var(--primary);
            margin-bottom: 30px;
            letter-spacing: 2px;
        }

        .panel {
            background: var(--light);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            color: var(--dark);
            border: 5px solid var(--secondary);
        }

        .control-group {
            margin: 20px 0;
        }

        label {
            font-size: 1.3rem;
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
            color: var(--dark);
        }

        input[type="number"] {
            padding: 10px 15px;
            font-size: 1.5rem;
            border-radius: 15px;
            border: 3px solid var(--secondary);
            width: 100px;
            text-align: center;
            font-family: 'Fredoka One', cursive;
            color: var(--primary);
            outline: none;
        }

        .file-upload-btn {
            background: var(--secondary);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            display: inline-block;
            transition: 0.2s;
            border: 3px solid transparent;
        }
        .file-upload-btn:hover {
             background: white;
             color: var(--secondary);
             border-color: var(--secondary);
        }

        #photo-upload { display: none; }

        .btn {
            background: var(--primary);
            color: var(--accent);
            padding: 15px 50px;
            font-size: 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Fredoka One', cursive;
            box-shadow: 0 8px 0 #c0392b;
            transition: transform 0.1s, box-shadow 0.1s;
            margin-top: 20px;
            text-transform: uppercase;
        }

        .btn:hover { transform: translateY(2px); box-shadow: 0 6px 0 #c0392b; }
        .btn:active { transform: translateY(8px); box-shadow: 0 0px 0 #c0392b; }

        .preview-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 90%;
        }

        .preview-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--accent);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.8);
            padding: 10px 20px;
            border-radius: 15px;
            border: 3px solid var(--accent);
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark);
            z-index: 5;
            font-family: 'Fredoka One', cursive;
        }

        /* Winner Screen */
        #winner-avatar {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 8px solid var(--accent);
            box-shadow: 0 0 60px var(--accent);
            margin-bottom: 20px;
            object-fit: cover;
            background: var(--light);
        }
        #winner-text {
            font-family: 'Fredoka One';
            font-size: 3rem;
            color: var(--accent);
             text-shadow: 2px 2px 0 var(--primary);
        }
    </style>
</head>
<body>
    <div id="bg-clouds"></div>

    <div id="game-container">
        <div id="hud" class="hidden">–õ–∏–¥–µ—Ä: <span id="leader-name">---</span></div>
    </div>

    <div id="start-screen" class="ui-screen">
        <h1>–ú—É–ª—å—Ç—è—à–Ω—ã–µ –ì–æ–Ω–∫–∏!</h1>
        
        <div class="panel">
            <div class="control-group">
                <label>–°–∫–æ–ª—å–∫–æ —à–∞—Ä–∏–∫–æ–≤?</label>
                <input type="number" id="ball-count" value="20" min="2" max="100">
            </div>

            <div class="control-group">
                <label for="photo-upload" class="file-upload-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫–∏ üì∏</label>
                <input type="file" id="photo-upload" accept="image/*" multiple>
                <div class="preview-container" id="preview-area"></div>
            </div>
            
             <p style="font-size: 0.9rem; opacity: 0.8;">–ï—Å–ª–∏ —Ñ–æ—Ç–æ –º–µ–Ω—å—à–µ —á–µ–º —à–∞—Ä–∏–∫–æ–≤, –æ–Ω–∏ –ø–æ–≤—Ç–æ—Ä—è—Ç—Å—è.</p>
        </div>

        <button class="btn" onclick="startGame()">–ü–û–ï–•–ê–õ–ò!</button>
    </div>

    <div id="winner-screen" class="ui-screen hidden">
        <h1>üèÜ –ü–û–ë–ï–î–ê! üèÜ</h1>
        <img id="winner-avatar" src="" alt="Winner">
        <h2 id="winner-text">Ball #1</h2>
        <button class="btn" onclick="location.reload()">–ï–©–Å –†–ê–ó!</button>
    </div>

    <script>
        // --- AUDIO ENGINE (Simple Synths for Cartoon Effect) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'start') {
                // Cartoon "boing" start up
                osc.type = 'sine';
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);
            } else if (type === 'win') {
                // Victory fanfare chirp
                osc.type = 'square';
                const now = audioCtx.currentTime;
                osc.frequency.setValueAtTime(523.25, now); // C5
                osc.frequency.setValueAtTime(659.25, now + 0.2); // E5
                osc.frequency.setValueAtTime(783.99, now + 0.4); // G5
                osc.frequency.setValueAtTime(1046.50, now + 0.6); // C6
                gainNode.gain.setValueAtTime(0.4, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 1.5);
                osc.start(); osc.stop(now + 1.5);
            }
        }

        // --- GAME CORE ---
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner,
              Bodies = Matter.Bodies, Composite = Matter.Composite, 
              Events = Matter.Events, Vector = Matter.Vector, Body = Matter.Body;

        let engine, runner;
        let canvas, ctx;
        let balls = [];
        let userImages = [];
        let isRaceActive = false;
        let cameraY = 0;
        let width = window.innerWidth;
        let height = window.innerHeight;

        // --- SETTINGS FOR CARTOON FEEL ---
        const ballRadius = 18; // –ü–æ–±–æ–ª—å—à–µ —à–∞—Ä–∏–∫–∏
        // –û—á–µ–Ω—å –≤–∞–∂–Ω–æ: –º–∞–ª–µ–Ω—å–∫–∞—è –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è –∏ –≤—ã—Å–æ–∫–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –≤–æ–∑–¥—É—Ö–∞ –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∫–∞—Ç–∞–Ω–∏—è
        const gravityY = 0.35; 
        const airFriction = 0.015; 
        const bounce = 0.4;
        
        // Track building blocks
        const trackColors = ['#4ECDC4', '#FF6B6B', '#FFE66D', '#A8E6CF'];
        const wallColor = '#2C3E50';

        // --- IMAGE UPLOAD HANDLING ---
        document.getElementById('photo-upload').addEventListener('change', function(e) {
            const files = e.target.files;
            const previewArea = document.getElementById('preview-area');
            previewArea.innerHTML = '';
            userImages = [];
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image(); img.src = event.target.result;
                    userImages.push(img);
                    const thumb = document.createElement('img');
                    thumb.src = event.target.result;
                    thumb.className = 'preview-img';
                    previewArea.appendChild(thumb);
                };
                reader.readAsDataURL(file);
            });
        });

        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            if(canvas) { canvas.width = width; canvas.height = height; }
        });

        function initPhysics() {
            engine = Engine.create();
            engine.world.gravity.y = gravityY; 
            canvas = document.createElement('canvas');
            canvas.width = width; canvas.height = height;
            document.getElementById('game-container').appendChild(canvas);
            ctx = canvas.getContext('2d');
            runner = Runner.create();
        }

        // --- THE CARTOON RACE TRACK GENERATOR ---
        function createTrack() {
            const world = engine.world;
            let currentY = 100;
            let side = 1; // 1 for right slope, -1 for left slope

            // Helper to create thick, rounded walls
            const createWall = (x, y, w, h, angle, color) => {
                return Bodies.rectangle(x, y, w, h, {
                    isStatic: true, angle: angle,
                    render: { fillStyle: color, strokeStyle: wallColor, lineWidth: 4 },
                    chamfer: { radius: 10 } // Rounded corners!
                });
            };

            // --- Start Platform (Funnel shape) ---
            Composite.add(world, [
                createWall(width*0.3, currentY, width*0.5, 30, Math.PI/6, trackColors[0]),
                createWall(width*0.7, currentY, width*0.5, 30, -Math.PI/6, trackColors[0])
            ]);
            currentY += 300;

            // --- Generate Zig-Zag Sections ---
            for (let i = 0; i < 12; i++) { // –ú–Ω–æ–≥–æ —Å–µ–∫—Ü–∏–π –¥–ª—è –¥–ª–∏–Ω–Ω–æ–π –≥–æ–Ω–∫–∏
                const sectionType = i % 4;
                const color = trackColors[i % trackColors.length];
                const slopeAngle = Math.PI / 10 * side; // Shallow angle for slow roll

                if (sectionType === 0 || sectionType === 2) {
                    // === Long Slope ===
                    const slopeLen = width * 0.9;
                    const slopeX = width/2 + (width*0.1 * -side);
                    Composite.add(world, createWall(slopeX, currentY, slopeLen, 30, slopeAngle, color));
                    // Add small bumper at end of slope to bounce them turn
                    Composite.add(world, Bodies.circle(
                        slopeX + (slopeLen/2 * side), currentY + 150, 25, 
                        { isStatic: true, render: { fillStyle: '#FF6B6B' }, restitution: 1.2 }
                    ));
                    currentY += 350;

                } else if (sectionType === 1) {
                    // === The Big Funnel (–í–æ—Ä–æ–Ω–∫–∞) ===
                    const funnelY = currentY + 100;
                    Composite.add(world, [
                        createWall(width*0.25, funnelY, width*0.6, 30, Math.PI/4, color),
                        createWall(width*0.75, funnelY, width*0.6, 30, -Math.PI/4, color),
                        // Narrow exit
                        createWall(width*0.4, funnelY+250, width*0.3, 30, Math.PI/2.5, color),
                        createWall(width*0.6, funnelY+250, width*0.3, 30, -Math.PI/2.5, color)
                    ]);
                    currentY += 600;

                } else if (sectionType === 3) {
                    // === Bumper Field (–ü–∏–Ω–±–æ–ª) ===
                    // Floor for bumpers
                    Composite.add(world, createWall(width/2, currentY+200, width*0.8, 30, slopeAngle/2, color));
                    
                    for(let k=0; k<8; k++) {
                        const bx = width/2 + (Math.random()*width*0.6 - width*0.3);
                        const by = currentY + (Math.random()*150);
                        const bumper = Bodies.circle(bx, by, 15 + Math.random()*10, {
                            isStatic: true, render: { fillStyle: trackColors[(i+k)%4] }, restitution: 1.3
                        });
                        Composite.add(world, bumper);
                    }
                    currentY += 400;
                }
                side *= -1; // Switch direction
            }

            // === Finish Line ===
            const finishLineY = currentY + 200;
            const finishFloor = Bodies.rectangle(width/2, finishLineY, width, 200, { 
                isStatic: true, label: 'finishFloor', render: { fillStyle: '#2C3E50' } 
            });
            // Finish checkers pattern
            for(let j=0; j<20; j++) {
                 Composite.add(world, Bodies.rectangle(
                     (j*(width/20)) + width/40, finishLineY - 110, width/20, 20, 
                     { isStatic:true, render: { fillStyle: j%2==0 ? '#fff' : '#000' }}
                 ));
            }
            Composite.add(world, finishFloor);
            trackLength = finishLineY; // Save for camera logic
        }

        let trackLength = 0;

        // --- START GAME ---
        function startGame() {
            const count = parseInt(document.getElementById('ball-count').value);
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            initPhysics();
            createTrack();
            playSound('start');

            // Spawn Marbles
            for (let i = 0; i < count; i++) {
                const x = width/2 + (Math.random() * 100 - 50);
                const y = -50 - (i * 40); // Stack above screen
                const img = userImages.length > 0 ? userImages[i % userImages.length] : null;
                // Pastel colors
                const hue = Math.floor(Math.random() * 360);
                const color = `hsl(${hue}, 80%, 70%)`;
                
                const ball = Bodies.circle(x, y, ballRadius, {
                    restitution: bounce,
                    friction: 0.005,
                    frictionAir: airFriction, // KEY for slow movement
                    density: 0.05,
                    label: 'marble',
                    render: { fillStyle: color }
                });
                
                ball.customId = i + 1;
                ball.customImg = img;
                ball.customColor = color;
                // Give random initial spin
                Body.setAngularVelocity(ball, (Math.random()-0.5)*0.2);
                balls.push(ball);
                Composite.add(engine.world, ball);
            }

            isRaceActive = true;
            Runner.run(runner, engine);
            requestAnimationFrame(gameLoop);
        }

        // --- RENDERING ---
        function drawCamera() {
            if(balls.length === 0) return;
            // Find leader
            let maxY = -Infinity;
            let leader = null;
            balls.forEach(b => {
                if (b.position.y > maxY) { maxY = b.position.y; leader = b; }
            });
            if(leader) document.getElementById('leader-name').innerText = "#" + leader.customId;

            // Smooth camera follow
            let targetY = -maxY + height * 0.6; 
            if (targetY > 100) targetY = 100; // Cap top
            // Cap bottom based on track length
            const minCameraY = -(trackLength - height + 100);
            if (targetY < minCameraY) targetY = minCameraY;

            cameraY += (targetY - cameraY) * 0.08; // Softer damping

            ctx.clearRect(0, 0, width, height);
            ctx.save();
            ctx.translate(0, cameraY);
        }

        function drawCartoonBody(body) {
            ctx.beginPath();
            const v = body.vertices;
            ctx.moveTo(v[0].x, v[0].y);
            for (let j = 1; j < v.length; j++) ctx.lineTo(v[j].x, v[j].y);
            ctx.closePath();

            if (body.label === 'marble') {
                ctx.save();
                ctx.translate(body.position.x, body.position.y);
                ctx.rotate(body.angle);
                ctx.beginPath(); ctx.arc(0, 0, ballRadius, 0, Math.PI*2); ctx.clip();
                
                if (body.customImg) {
                    ctx.drawImage(body.customImg, -ballRadius, -ballRadius, ballRadius*2, ballRadius*2);
                } else {
                     // Radial gradient for 3D shiny look
                    const grad = ctx.createRadialGradient(-5, -5, 2, 0, 0, ballRadius);
                    grad.addColorStop(0, '#ffffff');
                    grad.addColorStop(0.3, body.customColor);
                    grad.addColorStop(1, body.render.fillStyle);
                    ctx.fillStyle = grad;
                    ctx.fill();
                }
                // Extra Shine
                ctx.beginPath();
                ctx.ellipse(-ballRadius*0.3, -ballRadius*0.3, ballRadius*0.4, ballRadius*0.2, Math.PI/4, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.fill();
                ctx.restore();

                // Number overlay
                 if (!body.customImg) {
                    ctx.fillStyle = "rgba(0,0,0,0.5)";
                    ctx.font = "bold 14px Nunito";
                    ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    ctx.fillText(body.customId, body.position.x, body.position.y+1);
                    ctx.fillStyle = "#fff";
                    ctx.fillText(body.customId, body.position.x, body.position.y);
                 }

            } else {
                // Walls
                ctx.fillStyle = body.render.fillStyle;
                ctx.fill();
                if(body.render.strokeStyle) {
                     ctx.lineWidth = body.render.lineWidth;
                     ctx.strokeStyle = body.render.strokeStyle;
                     ctx.stroke();
                }
            }
        }

        function gameLoop() {
            if (!isRaceActive) return;
            drawCamera();
            
            const bodies = Composite.allBodies(engine.world);
            bodies.forEach(body => {
                // Culling
                if (body.position.y + cameraY < -200 || body.position.y + cameraY > height + 200) return;
                drawCartoonBody(body);
                // Check finish condition
                if (body.label === 'marble' && body.position.y > trackLength - 150) {
                    endGame(body);
                }
            });
            ctx.restore();
            requestAnimationFrame(gameLoop);
        }

        function endGame(winner) {
            if (!isRaceActive) return;
            isRaceActive = false;
            playSound('win');
            document.getElementById('winner-screen').classList.remove('hidden');
            document.getElementById('hud').classList.add('hidden');
            
            const avatar = document.getElementById('winner-avatar');
            if (winner.customImg) avatar.src = winner.customImg.src;
            else {
                avatar.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII='; // transparent pixel
                avatar.style.backgroundColor = winner.customColor;
            }
            document.getElementById('winner-text').innerText = `–ú—Ä–∞–º–æ—Ä #${winner.customId}`;
            Runner.stop(runner);
        }
    </script>
</body>
</html>
